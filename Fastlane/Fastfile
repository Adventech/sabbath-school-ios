# More documentation about how to customize your build
# can be found here:
# https://docs.fastlane.tools
# fastlane_version "1.109.0"

default_platform :ios

# Fastfile actions accept additional configuration, but
# don't worry, fastlane will prompt you for required
# info which you can add here later

lane :testflights do
  
end

desc "Configure local environment certificates"
  lane :match_config do
  match_sync(type: "development")
  match_sync(type: "adhoc")
end

lane :beta do
  match_sync(type: "appstore")
  increment_build_number
  build
  pilot
end

lane :release do
  match_sync(type: "appstore")
  increment_build
  build(submit: true)
  deliverApp
end

lane :deliverApp do |options|
  submit_for_review = options[:submit]
  deliver(
    submit_for_review: submit_for_review,
    force: true,
    automatic_release: false,
    skip_screenshots: true
  )
end

lane :build do
  gym(
    workspace: "./Sabbath School.xcworkspace",
    scheme: "Sabbath School",
    clean: true,
    include_bitcode: true,
    configuration: "Release",
    output_directory: "./Fastlane/build"
  )
end

desc "Generate screenshots and upload to the App Store"
lane :screenshots do
  sh "export LC_ALL=en_US.UTF-8"
  sh "export LANG=en_US.UTF-8"
  # sh "xcrun simctl list devices | grep -v '^[-=]' | cut -d \"(\" -f2 | cut -d \")\" -f1 | xargs -I {} xcrun simctl erase \"{}\""
  snapshot
  frameit(white: true)
end

# lane :increment_build do
#   date_number = Time.new.strftime("%Y.%m")
#   build_number = "#{date_number}.#{number_of_commits}"
#   increment_build_number(build_number: build_number)
# end

desc "Sync your certificates and profiles across your team using git"
lane :match_sync do |options|
  type = options[:type]
  match(
    git_url: "git@github.org:Adventech/sabbath-school-certificates.git",
    app_identifier: ["com.cryart.SabbathSchool"],
    type: type,
    force_for_new_devices: true
  )
end